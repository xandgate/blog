#!/usr/bin/env node
/**
 * Generate blog post summaries and markdown copies into notes/blog for easy review.
 * Run: npm run blog:from-posts
 * Reads: src/app/blog/posts/*.mdx
 * Writes: notes/blog/summaries/<slug>.md, notes/blog/index.md
 */

import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const ROOT = path.resolve(__dirname, "..");
const POSTS_DIR = path.join(ROOT, "src", "app", "blog", "posts");
const OUT_SUMMARIES = path.join(ROOT, "notes", "blog", "summaries");
const OUT_INDEX = path.join(ROOT, "notes", "blog", "index.md");

function parseFrontmatter(raw) {
  const match = raw.match(/^---\r?\n([\s\S]*?)\r?\n---\r?\n([\s\S]*)$/);
  if (!match) return { data: {}, content: raw };
  const [, front, content] = match;
  const data = {};
  for (const line of front.split(/\r?\n/)) {
    const m = line.match(/^(\w+):\s*(.*)$/);
    if (m) {
      let v = m[2].trim();
      if ((v.startsWith('"') && v.endsWith('"')) || (v.startsWith("'") && v.endsWith("'"))) v = v.slice(1, -1).replace(/\\"/g, '"');
      data[m[1]] = v;
    }
  }
  return { data, content: content.trim() };
}

function getMdxFiles(dir) {
  if (!fs.existsSync(dir)) {
    console.error("Posts dir not found:", dir);
    process.exit(1);
  }
  return fs.readdirSync(dir).filter((f) => path.extname(f) === ".mdx");
}

function readPost(filePath) {
  const raw = fs.readFileSync(filePath, "utf-8");
  const { data, content } = parseFrontmatter(raw);
  return {
    title: data.title || "",
    subtitle: data.subtitle || "",
    summary: data.summary || "",
    publishedAt: data.publishedAt || "",
    tag: data.tag || "",
    image: data.image || "",
    content,
  };
}

function slugFromFile(file) {
  return path.basename(file, path.extname(file));
}

function ensureDir(dir) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
  }
}

function main() {
  ensureDir(OUT_SUMMARIES);

  const files = getMdxFiles(POSTS_DIR);
  const entries = [];

  for (const file of files) {
    const slug = slugFromFile(file);
    const filePath = path.join(POSTS_DIR, file);
    const { title, subtitle, summary, publishedAt, tag, image, content } = readPost(filePath);

    entries.push({
      slug,
      title,
      subtitle,
      summary,
      publishedAt,
      tag,
      image,
    });

    const summaryMd = `# ${title}
${subtitle ? `**${subtitle}**\n` : ""}

- **Slug:** \`${slug}\`
- **Published:** ${publishedAt}
- **Tag:** ${tag || "—"}
- **Image:** ${image || "—"}

## Summary (for cards/SEO)

${summary}

---

## Full copy (for review / edit in notes)

${content}
`;

    const outPath = path.join(OUT_SUMMARIES, `${slug}.md`);
    fs.writeFileSync(outPath, summaryMd, "utf-8");
    console.log("Wrote", outPath);
  }

  entries.sort((a, b) => (b.publishedAt || "").localeCompare(a.publishedAt || ""));

  const indexMd = `# Blog posts index

Generated by \`npm run blog:from-posts\`. Use these for review and publication workflow.

| Title | Slug | Published | Tag |
|-------|------|-----------|-----|
${entries.map((e) => `| ${e.title} | \`${e.slug}\` | ${e.publishedAt} | ${e.tag || "—"} |`).join("\n")}

## Per-post summary + copy

See \`summaries/<slug>.md\` for each post (summary + full markdown copy).
`;

  fs.writeFileSync(OUT_INDEX, indexMd, "utf-8");
  console.log("Wrote", OUT_INDEX);
  console.log("Done. %d posts → notes/blog/summaries/ and index.", entries.length);
}

main();
